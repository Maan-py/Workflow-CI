name: CI MLflow with Docker and LFS

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  mlflow-docker-lfs:
    runs-on: ubuntu-latest
    environment: github-actions

    steps:
      # 1. Set up job
      - name: Set up job
        run: echo "Starting MLflow CI/CD job"

      # 2. Checkout repo
      - name: Run actions/checkout@v3
        uses: actions/checkout@v3
        with:
          lfs: true

      # 3. Set up Python 3.12.7
      - name: Set up Python 3.12.7
        uses: actions/setup-python@v4
        with:
          python-version: 3.12.7

      # 4. Check Env
      - name: Check Env
        run: env

      # 5. Install dependencies
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install mlflow scikit-learn pandas numpy docker

      # 6. Run MLflow project
      - name: Run MLflow project
        id: run_ml
        run: |
          RUN_ID=$(mlflow run MLProject --env-manager=local --experiment-name workflow-ci -q --no-conda -e main | grep "Run ID:" | awk '{print $NF}')
          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run ID: $RUN_ID"

      # 7. Get latest MLflow run_id
      - name: Get latest MLflow run_id
        run: |
          echo "Run ID: $RUN_ID"

      # 9. Upload to GitHub (LFS)
      - name: Upload MLflow artifacts to LFS
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git lfs install
          git lfs track "mlruns/**"
          git add .gitattributes
          git commit -m "Track large files in mlruns with Git LFS" || true
          git push origin master

      # 10. Build Docker Model
      - name: Build Docker Model
        run: |
          mlflow models build-docker \
            --model-uri "runs:/$RUN_ID/model" \
            --name "unsw-nb15-model"

      # 11. Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 12. Tag Docker Image
      - name: Tag Docker Image
        run: |
          docker tag unsw-nb15-model ${{ secrets.DOCKER_USERNAME }}/unsw-nb15-model:latest

      # 13. Push Docker Image
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/unsw-nb15-model:latest

      # 14. Post Log in to Docker Hub
      - name: Post Log in to Docker Hub
        run: echo "Docker Hub login completed"

      # 15. Post Set up Python 3.12.7
      - name: Post Set up Python 3.12.7
        run: echo "Python setup completed"

      # 16. Post Run actions/checkout@v3
      - name: Post Run actions/checkout@v3
        run: echo "Checkout step post-run"

      # 17. Complete job
      - name: Complete job
        run: echo "MLflow CI/CD job finished successfully"
